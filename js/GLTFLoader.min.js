THREE.GLTFLoader=function(){function e(e){THREE.Loader.call(this,e),this.dracoLoader=null,this.ddsLoader=null}function a(){var r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}e.prototype=Object.assign(Object.create(THREE.Loader.prototype),{constructor:e,load:function(t,r,e,a){var s=this,n=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:THREE.LoaderUtils.extractUrlBase(t);s.manager.itemStart(t);function o(e){a?a(e):console.error(e),s.manager.itemError(t),s.manager.itemEnd(t)}var i=new THREE.FileLoader(s.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),"use-credentials"===s.crossOrigin&&i.setWithCredentials(!0),i.load(t,function(e){try{s.parse(e,n,function(e){r(e),s.manager.itemEnd(t)},o)}catch(e){o(e)}},e,o)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},parse:function(e,t,r,a){var s,n={};if("string"==typeof e)s=e;else if(THREE.LoaderUtils.decodeText(new Uint8Array(e,0,4))===m){try{n[f.KHR_BINARY_GLTF]=new E(e)}catch(e){return void(a&&a(e))}s=n[f.KHR_BINARY_GLTF].content}else s=THREE.LoaderUtils.decodeText(new Uint8Array(e));var o=JSON.parse(s);if(void 0===o.asset||o.asset.version[0]<2)a&&a(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{if(o.extensionsUsed)for(var i=0;i<o.extensionsUsed.length;++i){var l=o.extensionsUsed[i],c=o.extensionsRequired||[];switch(l){case f.KHR_LIGHTS_PUNCTUAL:n[l]=new p(o);break;case f.KHR_MATERIALS_CLEARCOAT:n[l]=new d;break;case f.KHR_MATERIALS_UNLIT:n[l]=new h;break;case f.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:n[l]=new R;break;case f.KHR_DRACO_MESH_COMPRESSION:n[l]=new T(o,this.dracoLoader);break;case f.MSFT_TEXTURE_DDS:n[l]=new u(this.ddsLoader);break;case f.KHR_TEXTURE_TRANSFORM:n[l]=new g;break;case f.KHR_MESH_QUANTIZATION:n[l]=new M;break;default:0<=c.indexOf(l)&&console.warn('THREE.GLTFLoader: Unknown extension "'+l+'".')}}new z(o,n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(r,a)}}});var f={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function u(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader");this.name=f.MSFT_TEXTURE_DDS,this.ddsLoader=e}function p(e){this.name=f.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[f.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function h(){this.name=f.KHR_MATERIALS_UNLIT}function d(){this.name=f.KHR_MATERIALS_CLEARCOAT}p.prototype.loadLight=function(e){var t,r=this.lightDefs[e],a=new THREE.Color(16777215);void 0!==r.color&&a.fromArray(r.color);var s=void 0!==r.range?r.range:0;switch(r.type){case"directional":(t=new THREE.DirectionalLight(a)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new THREE.PointLight(a)).distance=s;break;case"spot":(t=new THREE.SpotLight(a)).distance=s,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,t.angle=r.spot.outerConeAngle,t.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+r.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==r.intensity&&(t.intensity=r.intensity),t.name=r.name||"light_"+e,Promise.resolve(t)},h.prototype.getMaterialType=function(){return THREE.MeshBasicMaterial},h.prototype.extendParams=function(e,t,r){var a=[];e.color=new THREE.Color(1,1,1),e.opacity=1;var s,n=t.pbrMetallicRoughness;return n&&(Array.isArray(n.baseColorFactor)&&(s=n.baseColorFactor,e.color.fromArray(s),e.opacity=s[3]),void 0!==n.baseColorTexture&&a.push(r.assignTexture(e,"map",n.baseColorTexture))),Promise.all(a)},d.prototype.getMaterialType=function(){return THREE.MeshPhysicalMaterial},d.prototype.extendParams=function(e,t,r){var a,s=[],n=t.extensions[this.name];return void 0!==n.clearcoatFactor&&(e.clearcoat=n.clearcoatFactor),void 0!==n.clearcoatTexture&&s.push(r.assignTexture(e,"clearcoatMap",n.clearcoatTexture)),void 0!==n.clearcoatRoughnessFactor&&(e.clearcoatRoughness=n.clearcoatRoughnessFactor),void 0!==n.clearcoatRoughnessTexture&&s.push(r.assignTexture(e,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),void 0!==n.clearcoatNormalTexture&&(s.push(r.assignTexture(e,"clearcoatNormalMap",n.clearcoatNormalTexture)),void 0!==n.clearcoatNormalTexture.scale&&(a=n.clearcoatNormalTexture.scale,e.clearcoatNormalScale=new THREE.Vector2(a,a))),Promise.all(s)};var m="glTF",l=12,c={JSON:1313821514,BIN:5130562};function E(e){this.name=f.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,l);if(this.header={magic:THREE.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==m)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var r=new DataView(e,l),a=0;a<r.byteLength;){var s=r.getUint32(a,!0);a+=4;var n,o,i=r.getUint32(a,!0);a+=4,i===c.JSON?(n=new Uint8Array(e,l+a,s),this.content=THREE.LoaderUtils.decodeText(n)):i===c.BIN&&(o=l+a,this.body=e.slice(o,o+s)),a+=s}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function T(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=f.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function g(){this.name=f.KHR_TEXTURE_TRANSFORM}function v(e){THREE.MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var r=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),a=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),s=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),i={specular:{value:(new THREE.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=i,this.onBeforeCompile=function(e){for(var t in i)e.uniforms[t]=i[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",r),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",a),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",s),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return i.specular.value},set:function(e){i.specular.value=e}},specularMap:{get:function(){return i.specularMap.value},set:function(e){i.specularMap.value=e}},glossiness:{get:function(){return i.glossiness.value},set:function(e){i.glossiness.value=e}},glossinessMap:{get:function(){return i.glossinessMap.value},set:function(e){(i.glossinessMap.value=e)?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function R(){return{name:f.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return v},extendParams:function(e,t,r){var a=t.extensions[this.name];e.color=new THREE.Color(1,1,1),e.opacity=1;var s,n,o=[];return Array.isArray(a.diffuseFactor)&&(s=a.diffuseFactor,e.color.fromArray(s),e.opacity=s[3]),void 0!==a.diffuseTexture&&o.push(r.assignTexture(e,"map",a.diffuseTexture)),e.emissive=new THREE.Color(0,0,0),e.glossiness=void 0!==a.glossinessFactor?a.glossinessFactor:1,e.specular=new THREE.Color(1,1,1),Array.isArray(a.specularFactor)&&e.specular.fromArray(a.specularFactor),void 0!==a.specularGlossinessTexture&&(n=a.specularGlossinessTexture,o.push(r.assignTexture(e,"glossinessMap",n)),o.push(r.assignTexture(e,"specularMap",n))),Promise.all(o)},createMaterial:function(e){var t=new v(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=THREE.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function M(){this.name=f.KHR_MESH_QUANTIZATION}function A(e,t,r,a){THREE.Interpolant.call(this,e,t,r,a)}T.prototype.decodePrimitive=function(e,t){var r=this.json,a=this.dracoLoader,s=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,o={},i={},l={};for(var c in n){var u=F[c]||c.toLowerCase();o[u]=n[c]}for(c in e.attributes){var p,h,u=F[c]||c.toLowerCase();void 0!==n[c]&&(p=r.accessors[e.attributes[c]],h=b[p.componentType],l[u]=h,i[u]=!0===p.normalized)}return t.getDependency("bufferView",s).then(function(e){return new Promise(function(s){a.decodeDracoFile(e,function(e){for(var t in e.attributes){var r=e.attributes[t],a=i[t];void 0!==a&&(r.normalized=a)}s(e)},o,l)})})},g.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},((v.prototype=Object.create(THREE.MeshStandardMaterial.prototype)).constructor=v).prototype.copy=function(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},((A.prototype=Object.create(THREE.Interpolant.prototype)).constructor=A).prototype.beforeStart_=A.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,a=this.valueSize,s=e*a*3+a,n=0;n!==a;n++)t[n]=r[s+n];return t},A.prototype.afterEnd_=A.prototype.copySampleValue_,A.prototype.interpolate_=function(e,t,r,a){for(var s=this.resultBuffer,n=this.sampleValues,o=this.valueSize,i=2*o,l=3*o,c=a-t,u=(r-t)/c,p=u*u,h=p*u,d=e*l,m=d-l,f=-2*h+3*p,E=h-p,T=1-f,g=E-p+u,v=0;v!==o;v++){var R=n[m+v+o],M=n[m+v+i]*c,y=n[d+v+o],S=n[d+v]*c;s[v]=T*R+g*M+f*y+E*S}return s};var y=0,S=1,H=2,L=3,x=4,_=5,w=6,b={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},I={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipmapNearestFilter,9985:THREE.LinearMipmapNearestFilter,9986:THREE.NearestMipmapLinearFilter,9987:THREE.LinearMipmapLinearFilter},P={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},C={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},F={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},O={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},N={CUBICSPLINE:void 0,LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete},U="OPAQUE",D="MASK",G="BLEND",B={"image/png":THREE.RGBAFormat,"image/jpeg":THREE.RGBFormat};function k(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function K(e,t,r){for(var a in r.extensions)void 0===e[a]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[a]=r.extensions[a])}function j(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function V(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,a=t.weights.length;r<a;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(r=0,a=s.length;r<a;r++)e.morphTargetDictionary[s[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function X(e){for(var t="",r=Object.keys(e).sort(),a=0,s=r.length;a<s;a++)t+=r[a]+":"+e[r[a]]+";";return t}function z(e,t,r){this.json=e||{},this.extensions=t||{},this.options=r||{},this.cache=new a,this.primitiveCache={},this.textureLoader=new THREE.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new THREE.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function W(r,e,a){var t,s=e.attributes,n=[];function o(e,t){return a.getDependency("accessor",e).then(function(e){r.setAttribute(t,e)})}for(var i in s){var l=F[i]||i.toLowerCase();l in r.attributes||n.push(o(s[i],l))}return void 0===e.indices||r.index||(t=a.getDependency("accessor",e.indices).then(function(e){r.setIndex(e)}),n.push(t)),j(r,e),function(e,t,r){var a=t.attributes,s=new THREE.Box3;if(void 0!==a.POSITION){var n=(h=r.json.accessors[a.POSITION]).min,o=h.max;if(void 0!==n&&void 0!==o){s.set(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(o[0],o[1],o[2]));var i=t.targets;if(void 0!==i){for(var l=new THREE.Vector3,c=new THREE.Vector3,u=0,p=i.length;u<p;u++){var h,d=i[u];void 0!==d.POSITION&&(n=(h=r.json.accessors[d.POSITION]).min,o=h.max,void 0!==n&&void 0!==o?(c.setX(Math.max(Math.abs(n[0]),Math.abs(o[0]))),c.setY(Math.max(Math.abs(n[1]),Math.abs(o[1]))),c.setZ(Math.max(Math.abs(n[2]),Math.abs(o[2]))),l.max(c)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION."))}s.expandByVector(l)}e.boundingBox=s;var m=new THREE.Sphere;s.getCenter(m.center),m.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=m}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(r,e,a),Promise.all(n).then(function(){return void 0!==e.targets?function(a,e,t){for(var s=!1,n=!1,r=0,o=e.length;r<o;r++){if(void 0!==(u=e[r]).POSITION&&(s=!0),void 0!==u.NORMAL&&(n=!0),s&&n)break}if(!s&&!n)return Promise.resolve(a);for(var i=[],l=[],r=0,o=e.length;r<o;r++){var c,u=e[r];s&&(c=void 0!==u.POSITION?t.getDependency("accessor",u.POSITION):a.attributes.position,i.push(c)),n&&(c=void 0!==u.NORMAL?t.getDependency("accessor",u.NORMAL):a.attributes.normal,l.push(c))}return Promise.all([Promise.all(i),Promise.all(l)]).then(function(e){var t=e[0],r=e[1];return s&&(a.morphAttributes.position=t),n&&(a.morphAttributes.normal=r),a.morphTargetsRelative=!0,a})}(r,e.targets,a):r})}function Y(e,t){var r=e.getIndex();if(null===r){var a=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var n=0;n<s.count;n++)a.push(n);e.setIndex(a),r=e.getIndex()}var o=r.count-2,i=[];if(t===THREE.TriangleFanDrawMode)for(n=1;n<=o;n++)i.push(r.getX(0)),i.push(r.getX(n)),i.push(r.getX(n+1));else for(n=0;n<o;n++)n%2==0?(i.push(r.getX(n)),i.push(r.getX(n+1)),i.push(r.getX(n+2))):(i.push(r.getX(n+2)),i.push(r.getX(n+1)),i.push(r.getX(n)));i.length/3!=o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(i),l}function J(e,o,i,c){var u=i.nodes[e];return c.getDependency("node",e).then(function(e){return void 0===u.skin?e:c.getDependency("skin",u.skin).then(function(e){for(var t=[],r=0,a=(l=e).joints.length;r<a;r++)t.push(c.getDependency("node",l.joints[r]));return Promise.all(t)}).then(function(i){return e.traverse(function(e){if(e.isMesh){for(var t=[],r=[],a=0,s=i.length;a<s;a++){var n,o=i[a];o?(t.push(o),n=new THREE.Matrix4,void 0!==l.inverseBindMatrices&&n.fromArray(l.inverseBindMatrices.array,16*a),r.push(n)):console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',l.joints[a])}e.bind(new THREE.Skeleton(t,r),e.matrixWorld)}}),e});var l}).then(function(e){o.add(e);var t=[];if(u.children)for(var r=u.children,a=0,s=r.length;a<s;a++){var n=r[a];t.push(J(n,e,i,c))}return Promise.all(t)})}return z.prototype.parse=function(r,e){var a=this,s=this.json,n=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(e){var t={scene:e[0][s.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:s.asset,parser:a,userData:{}};K(n,t,s),j(t,s),r(t)}).catch(e)},z.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],a={},s={},n=0,o=t.length;n<o;n++)for(var i=t[n].joints,l=0,c=i.length;l<c;l++)e[i[l]].isBone=!0;for(var u=0,p=e.length;u<p;u++){var h=e[u];void 0!==h.mesh&&(void 0===a[h.mesh]&&(a[h.mesh]=s[h.mesh]=0),a[h.mesh]++,void 0!==h.skin&&(r[h.mesh].isSkinnedMesh=!0))}this.json.meshReferences=a,this.json.meshUses=s},z.prototype.getDependency=function(e,t){var r=e+":"+t,a=this.cache.get(r);if(!a){switch(e){case"scene":a=this.loadScene(t);break;case"node":a=this.loadNode(t);break;case"mesh":a=this.loadMesh(t);break;case"accessor":a=this.loadAccessor(t);break;case"bufferView":a=this.loadBufferView(t);break;case"buffer":a=this.loadBuffer(t);break;case"material":a=this.loadMaterial(t);break;case"texture":a=this.loadTexture(t);break;case"skin":a=this.loadSkin(t);break;case"animation":a=this.loadAnimation(t);break;case"camera":a=this.loadCamera(t);break;case"light":a=this.extensions[f.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,a)}return a},z.prototype.getDependencies=function(r){var a,e,t=this.cache.get(r);return t||(e=(a=this).json[r+("mesh"===r?"es":"s")]||[],t=Promise.all(e.map(function(e,t){return a.getDependency(r,t)})),this.cache.add(r,t)),t},z.prototype.loadBuffer=function(e){var r=this.json.buffers[e],a=this.fileLoader;if(r.type&&"arraybuffer"!==r.type)throw new Error("THREE.GLTFLoader: "+r.type+" buffer type is not supported.");if(void 0===r.uri&&0===e)return Promise.resolve(this.extensions[f.KHR_BINARY_GLTF].body);var s=this.options;return new Promise(function(e,t){a.load(k(r.uri,s.path),e,void 0,function(){t(new Error('THREE.GLTFLoader: Failed to load buffer "'+r.uri+'".'))})})},z.prototype.loadBufferView=function(e){var a=this.json.bufferViews[e];return this.getDependency("buffer",a.buffer).then(function(e){var t=a.byteLength||0,r=a.byteOffset||0;return e.slice(r,r+t)})},z.prototype.loadAccessor=function(e){var S=this,H=this.json,L=this.json.accessors[e];if(void 0===L.bufferView&&void 0===L.sparse)return Promise.resolve(null);var t=[];return void 0!==L.bufferView?t.push(this.getDependency("bufferView",L.bufferView)):t.push(null),void 0!==L.sparse&&(t.push(this.getDependency("bufferView",L.sparse.indices.bufferView)),t.push(this.getDependency("bufferView",L.sparse.values.bufferView))),Promise.all(t).then(function(e){var t,r,a,s,n=e[0],o=C[L.type],i=b[L.componentType],l=i.BYTES_PER_ELEMENT,c=l*o,u=L.byteOffset||0,p=void 0!==L.bufferView?H.bufferViews[L.bufferView].byteStride:void 0,h=!0===L.normalized,d=p&&p!==c?(r=Math.floor(u/p),a="InterleavedBuffer:"+L.bufferView+":"+L.componentType+":"+r+":"+L.count,(s=S.cache.get(a))||(t=new i(n,r*p,L.count*p/l),s=new THREE.InterleavedBuffer(t,p/l),S.cache.add(a,s)),new THREE.InterleavedBufferAttribute(s,o,u%p/l,h)):(t=null===n?new i(L.count*o):new i(n,u,L.count*o),new THREE.BufferAttribute(t,o,h));if(void 0!==L.sparse){var m=C.SCALAR,f=b[L.sparse.indices.componentType],E=L.sparse.indices.byteOffset||0,T=L.sparse.values.byteOffset||0,g=new f(e[1],E,L.sparse.count*m),v=new i(e[2],T,L.sparse.count*o);null!==n&&(d=new THREE.BufferAttribute(d.array.slice(),d.itemSize,d.normalized));for(var R=0,M=g.length;R<M;R++){var y=g[R];if(d.setX(y,v[R*o]),2<=o&&d.setY(y,v[R*o+1]),3<=o&&d.setZ(y,v[R*o+2]),4<=o&&d.setW(y,v[R*o+3]),5<=o)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return d})},z.prototype.loadTexture=function(e){var t=this,r=this.json,s=this.options,n=this.textureLoader,a=self.URL||self.webkitURL,o=r.textures[e],i=o.extensions||{},l=i[f.MSFT_TEXTURE_DDS]?r.images[i[f.MSFT_TEXTURE_DDS].source]:r.images[o.source],c=l.uri,u=!1;return void 0!==l.bufferView&&(c=t.getDependency("bufferView",l.bufferView).then(function(e){u=!0;var t=new Blob([e],{type:l.mimeType});return c=a.createObjectURL(t)})),Promise.resolve(c).then(function(r){var a=(a=s.manager.getHandler(r))||(i[f.MSFT_TEXTURE_DDS]?t.extensions[f.MSFT_TEXTURE_DDS].ddsLoader:n);return new Promise(function(e,t){a.load(k(r,s.path),e,void 0,t)})}).then(function(e){!0===u&&a.revokeObjectURL(c),e.flipY=!1,o.name&&(e.name=o.name),l.mimeType in B&&(e.format=B[l.mimeType]);var t=(r.samplers||{})[o.sampler]||{};return e.magFilter=I[t.magFilter]||THREE.LinearFilter,e.minFilter=I[t.minFilter]||THREE.LinearMipmapLinearFilter,e.wrapS=P[t.wrapS]||THREE.RepeatWrapping,e.wrapT=P[t.wrapT]||THREE.RepeatWrapping,e})},z.prototype.assignTexture=function(r,a,s){var n=this;return this.getDependency("texture",s.index).then(function(e){if(!e.isCompressedTexture)switch(a){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":e.format=THREE.RGBFormat}var t;void 0===s.texCoord||0==s.texCoord||"aoMap"===a&&1==s.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+s.texCoord+" for texture "+a+" not yet supported."),!n.extensions[f.KHR_TEXTURE_TRANSFORM]||(t=void 0!==s.extensions?s.extensions[f.KHR_TEXTURE_TRANSFORM]:void 0)&&(e=n.extensions[f.KHR_TEXTURE_TRANSFORM].extendTexture(e,t)),r[a]=e})},z.prototype.assignFinalMaterial=function(e){var t,r,a,s,n=e.geometry,o=e.material,i=void 0!==n.attributes.tangent,l=void 0!==n.attributes.color,c=void 0===n.attributes.normal,u=!0===e.isSkinnedMesh,p=0<Object.keys(n.morphAttributes).length,h=p&&void 0!==n.morphAttributes.normal;e.isPoints?(a="PointsMaterial:"+o.uuid,(t=this.cache.get(a))||(t=new THREE.PointsMaterial,THREE.Material.prototype.copy.call(t,o),t.color.copy(o.color),t.map=o.map,t.sizeAttenuation=!1,this.cache.add(a,t)),o=t):e.isLine&&(a="LineBasicMaterial:"+o.uuid,(r=this.cache.get(a))||(r=new THREE.LineBasicMaterial,THREE.Material.prototype.copy.call(r,o),r.color.copy(o.color),this.cache.add(a,r)),o=r),(i||l||c||u||p)&&(a="ClonedMaterial:"+o.uuid+":",o.isGLTFSpecularGlossinessMaterial&&(a+="specular-glossiness:"),u&&(a+="skinning:"),i&&(a+="vertex-tangents:"),l&&(a+="vertex-colors:"),c&&(a+="flat-shading:"),p&&(a+="morph-targets:"),h&&(a+="morph-normals:"),(s=this.cache.get(a))||(s=o.clone(),u&&(s.skinning=!0),i&&(s.vertexTangents=!0),l&&(s.vertexColors=!0),c&&(s.flatShading=!0),p&&(s.morphTargets=!0),h&&(s.morphNormals=!0),this.cache.add(a,s)),o=s),o.aoMap&&void 0===n.attributes.uv2&&void 0!==n.attributes.uv&&n.setAttribute("uv2",new THREE.BufferAttribute(n.attributes.uv.array,2)),o.normalScale&&!i&&(o.normalScale.y=-o.normalScale.y),o.clearcoatNormalScale&&!i&&(o.clearcoatNormalScale.y=-o.clearcoatNormalScale.y),e.material=o},z.prototype.loadMaterial=function(e){var t,r,a,s,n,o=this,i=this.json,l=this.extensions,c=i.materials[e],u={},p=c.extensions||{},h=[];p[f.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]?(t=l[f.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS],r=t.getMaterialType(),h.push(t.extendParams(u,c,o))):p[f.KHR_MATERIALS_UNLIT]?(a=l[f.KHR_MATERIALS_UNLIT],r=a.getMaterialType(),h.push(a.extendParams(u,c,o))):(r=THREE.MeshStandardMaterial,s=c.pbrMetallicRoughness||{},u.color=new THREE.Color(1,1,1),u.opacity=1,Array.isArray(s.baseColorFactor)&&(n=s.baseColorFactor,u.color.fromArray(n),u.opacity=n[3]),void 0!==s.baseColorTexture&&h.push(o.assignTexture(u,"map",s.baseColorTexture)),u.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,u.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(h.push(o.assignTexture(u,"metalnessMap",s.metallicRoughnessTexture)),h.push(o.assignTexture(u,"roughnessMap",s.metallicRoughnessTexture)))),!0===c.doubleSided&&(u.side=THREE.DoubleSide);var d,m=c.alphaMode||U;return m===G?(u.transparent=!0,u.depthWrite=!1):(u.transparent=!1,m===D&&(u.alphaTest=void 0!==c.alphaCutoff?c.alphaCutoff:.5)),void 0!==c.normalTexture&&r!==THREE.MeshBasicMaterial&&(h.push(o.assignTexture(u,"normalMap",c.normalTexture)),u.normalScale=new THREE.Vector2(1,1),void 0!==c.normalTexture.scale&&u.normalScale.set(c.normalTexture.scale,c.normalTexture.scale)),void 0!==c.occlusionTexture&&r!==THREE.MeshBasicMaterial&&(h.push(o.assignTexture(u,"aoMap",c.occlusionTexture)),void 0!==c.occlusionTexture.strength&&(u.aoMapIntensity=c.occlusionTexture.strength)),void 0!==c.emissiveFactor&&r!==THREE.MeshBasicMaterial&&(u.emissive=(new THREE.Color).fromArray(c.emissiveFactor)),void 0!==c.emissiveTexture&&r!==THREE.MeshBasicMaterial&&h.push(o.assignTexture(u,"emissiveMap",c.emissiveTexture)),p[f.KHR_MATERIALS_CLEARCOAT]&&(d=l[f.KHR_MATERIALS_CLEARCOAT],r=d.getMaterialType(),h.push(d.extendParams(u,{extensions:p},o))),Promise.all(h).then(function(){var e=r===v?l[f.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(u):new r(u);return c.name&&(e.name=c.name),e.map&&(e.map.encoding=THREE.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=THREE.sRGBEncoding),j(e,c),c.extensions&&K(l,e,c),e})},z.prototype.loadGeometries=function(e){var r=this,a=this.extensions,t=this.primitiveCache;function s(t){return a[f.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,r).then(function(e){return W(e,t,r)})}for(var n,o,i=[],l=0,c=e.length;l<c;l++){var u,p=e[l],h=(0,o=(n=p).extensions&&n.extensions[f.KHR_DRACO_MESH_COMPRESSION],o?"draco:"+o.bufferView+":"+o.indices+":"+X(o.attributes):n.indices+":"+X(n.attributes)+":"+n.mode),d=t[h];d?i.push(d.promise):(u=p.extensions&&p.extensions[f.KHR_DRACO_MESH_COMPRESSION]?s(p):W(new THREE.BufferGeometry,p,r),t[h]={primitive:p,promise:u},i.push(u))}return Promise.all(i)},z.prototype.loadMesh=function(p){for(var e,h=this,d=this.json.meshes[p],m=d.primitives,t=[],r=0,a=m.length;r<a;r++){var s=void 0===m[r].material?(void 0===(e=this.cache).DefaultMaterial&&(e.DefaultMaterial=new THREE.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:THREE.FrontSide})),e.DefaultMaterial):this.getDependency("material",m[r].material);t.push(s)}return t.push(h.loadGeometries(m)),Promise.all(t).then(function(e){for(var t=e.slice(0,e.length-1),r=e[e.length-1],a=[],s=0,n=r.length;s<n;s++){var o,i=r[s],l=m[s],c=t[s];if(l.mode===x||l.mode===_||l.mode===w||void 0===l.mode)!0!==(o=!0===d.isSkinnedMesh?new THREE.SkinnedMesh(i,c):new THREE.Mesh(i,c)).isSkinnedMesh||o.geometry.attributes.skinWeight.normalized||o.normalizeSkinWeights(),l.mode===_?o.geometry=Y(o.geometry,THREE.TriangleStripDrawMode):l.mode===w&&(o.geometry=Y(o.geometry,THREE.TriangleFanDrawMode));else if(l.mode===S)o=new THREE.LineSegments(i,c);else if(l.mode===L)o=new THREE.Line(i,c);else if(l.mode===H)o=new THREE.LineLoop(i,c);else{if(l.mode!==y)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);o=new THREE.Points(i,c)}0<Object.keys(o.geometry.morphAttributes).length&&V(o,d),o.name=d.name||"mesh_"+p,1<r.length&&(o.name+="_"+s),j(o,d),h.assignFinalMaterial(o),a.push(o)}if(1===a.length)return a[0];for(var u=new THREE.Group,s=0,n=a.length;s<n;s++)u.add(a[s]);return u})},z.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],a=r[r.type];if(a)return"perspective"===r.type?t=new THREE.PerspectiveCamera(THREE.MathUtils.radToDeg(a.yfov),a.aspectRatio||1,a.znear||1,a.zfar||2e6):"orthographic"===r.type&&(t=new THREE.OrthographicCamera(a.xmag/-2,a.xmag/2,a.ymag/2,a.ymag/-2,a.znear,a.zfar)),r.name&&(t.name=r.name),j(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},z.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return r.inverseBindMatrices=e,r})},z.prototype.loadAnimation=function(L){for(var x=this.json.animations[L],e=[],t=[],r=[],a=[],s=[],n=0,o=x.channels.length;n<o;n++){var i=x.channels[n],l=x.samplers[i.sampler],c=i.target,u=void 0!==c.node?c.node:c.id,p=void 0!==x.parameters?x.parameters[l.input]:l.input,h=void 0!==x.parameters?x.parameters[l.output]:l.output;e.push(this.getDependency("node",u)),t.push(this.getDependency("accessor",p)),r.push(this.getDependency("accessor",h)),a.push(l),s.push(c)}return Promise.all([Promise.all(e),Promise.all(t),Promise.all(r),Promise.all(a),Promise.all(s)]).then(function(e){for(var t=e[0],r=e[1],a=e[2],s=e[3],n=e[4],o=[],i=0,l=t.length;i<l;i++){var c,u=t[i],p=r[i],h=a[i],d=s[i],m=n[i];if(void 0!==u){switch(u.updateMatrix(),u.matrixAutoUpdate=!0,O[m.path]){case O.weights:c=THREE.NumberKeyframeTrack;break;case O.rotation:c=THREE.QuaternionKeyframeTrack;break;case O.position:case O.scale:default:c=THREE.VectorKeyframeTrack}var f=u.name?u.name:u.uuid,E=void 0!==d.interpolation?N[d.interpolation]:THREE.InterpolateLinear,T=[];O[m.path]===O.weights?u.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&T.push(e.name?e.name:e.uuid)}):T.push(f);var g,v=h.array;if(h.normalized){if(v.constructor===Int8Array)g=1/127;else if(v.constructor===Uint8Array)g=1/255;else if(v.constructor==Int16Array)g=1/32767;else{if(v.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");g=1/65535}for(var R=new Float32Array(v.length),M=0,y=v.length;M<y;M++)R[M]=v[M]*g;v=R}for(M=0,y=T.length;M<y;M++){var S=new c(T[M]+"."+O[m.path],p.array,v,E);"CUBICSPLINE"===d.interpolation&&(S.createInterpolant=function(e){return new A(this.times,this.values,this.getValueSize()/3,e)},S.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),o.push(S)}}}var H=x.name?x.name:"animation_"+L;return new THREE.AnimationClip(H,void 0,o)})},z.prototype.loadNode=function(e){var t,r=this.json,n=this.extensions,a=this,s=r.meshReferences,o=r.meshUses,i=r.nodes[e];return t=[],void 0!==i.mesh&&t.push(a.getDependency("mesh",i.mesh).then(function(e){var t,r;return 1<s[i.mesh]?(t=o[i.mesh]++,(r=e.clone()).name+="_instance_"+t):r=e,void 0!==i.weights&&r.traverse(function(e){if(e.isMesh)for(var t=0,r=i.weights.length;t<r;t++)e.morphTargetInfluences[t]=i.weights[t]}),r})),void 0!==i.camera&&t.push(a.getDependency("camera",i.camera)),i.extensions&&i.extensions[f.KHR_LIGHTS_PUNCTUAL]&&void 0!==i.extensions[f.KHR_LIGHTS_PUNCTUAL].light&&t.push(a.getDependency("light",i.extensions[f.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(t).then(function(e){var t,r=!0===i.isBone?new THREE.Bone:1<e.length?new THREE.Group:1===e.length?e[0]:new THREE.Object3D;if(r!==e[0])for(var a=0,s=e.length;a<s;a++)r.add(e[a]);return i.name&&(r.userData.name=i.name,r.name=THREE.PropertyBinding.sanitizeNodeName(i.name)),j(r,i),i.extensions&&K(n,r,i),void 0!==i.matrix?((t=new THREE.Matrix4).fromArray(i.matrix),r.applyMatrix4(t)):(void 0!==i.translation&&r.position.fromArray(i.translation),void 0!==i.rotation&&r.quaternion.fromArray(i.rotation),void 0!==i.scale&&r.scale.fromArray(i.scale)),r})},z.prototype.loadScene=function(e){var t=this.json,r=this.extensions,a=this.json.scenes[e],s=new THREE.Group;a.name&&(s.name=a.name),j(s,a),a.extensions&&K(r,s,a);for(var n=a.nodes||[],o=[],i=0,l=n.length;i<l;i++)o.push(J(n[i],s,t,this));return Promise.all(o).then(function(){return s})},e}();